# 调试指南：为什么播客没有日历和天气信息

## 问题原因

原始代码中，工具注册在 `Task { @MainActor in }` 异步块中执行：

```swift
init() {
    Task { @MainActor in  // ❌ 异步执行
        let rssTool = RSSTool(rssService: rssService)
        skillsEngine.register(tool: rssTool)
        // ...
    }
}
```

这导致 `init()` 返回时，工具可能还没注册完成。当用户立即点击生成播客时，`skillsEngine.toolRegistry` 可能是空的。

## 修复方案

改为同步注册：

```swift
init() {
    // ✅ 同步执行，确保在使用前完成
    let rssTool = RSSTool(rssService: rssService)
    skillsEngine.register(tool: rssTool)

    let weatherTool = WeatherTool()
    skillsEngine.register(tool: weatherTool)

    let calendarTool = AppleCalendarTool()
    skillsEngine.register(tool: calendarTool)

    print("✅ [PodcastService] 已注册 \(skillsEngine.toolRegistry.count) 个工具")
}
```

## 增强的调试日志

现在 SkillsEngine 会输出详细日志：

```
🎯 [SkillsEngine] 执行场景: podcast_generate
📋 [SkillsEngine] 已注册工具: ["calendar", "podcast", "rss", "weather"]
✅ [SkillsEngine] 匹配到 1 个 Skill: ["context_for_generation"]
🔧 [SkillsEngine] 执行 Skill: context_for_generation
🔍 [SkillsEngine] 查找工具: calendar
⚙️ [SkillsEngine] 执行工具 'calendar' with params: ["range": "today"]
✅ [SkillsEngine] 工具 'calendar' 成功，输出: 今日日程：...
🔍 [SkillsEngine] 查找工具: weather
⚙️ [SkillsEngine] 执行工具 'weather' with params: ["range": "today"]
✅ [SkillsEngine] 工具 'weather' 成功，输出: 当前天气：...
🔍 [SkillsEngine] 查找工具: rss
⚙️ [SkillsEngine] 执行工具 'rss' with params: ["range": "latest", "limit": 10]
✅ [SkillsEngine] 工具 'rss' 成功，输出: [1] 标题...
📦 [SkillsEngine] 合并结果: 523 字符
✅ [SkillsEngine] Skill context_for_generation 返回 523 字符
```

## 如何验证修复

### 1. 查看启动日志
应该看到：
```
✅ [PodcastService] 已注册 4 个工具
```

### 2. 生成播客时查看日志
应该看到：
```
📋 [SkillsEngine] 已注册工具: ["calendar", "podcast", "rss", "weather"]
```

如果看到空数组 `[]`，说明工具还没注册。

### 3. 检查权限
- **日历权限**：系统偏好设置 → 隐私与安全性 → 日历
- **位置权限**：系统偏好设置 → 隐私与安全性 → 定位服务

如果权限被拒绝，会看到：
```
❌ [SkillsEngine] 工具 'calendar' 执行失败: 日历权限被拒绝
❌ [SkillsEngine] 工具 'weather' 执行失败: 位置权限被拒绝
```

### 4. 检查 LLM Prompt
在日志中搜索 `[LLM Prompt]`，应该看到：

```
========== [LLM Prompt] ==========
你是一个播客脚本生成助手...

【情境上下文】
【calendar】今日日程：
- 09:00 团队站会
- 14:00 产品评审

【weather】当前天气：晴朗，温度 22°C
今日预报：最高 25°C，最低 18°C

【rss】[1] 标题1...
[2] 标题2...

以上是通过工具获取的实时情境信息，可作为播客内容的补充素材或开场参考。
==================================
```

## 常见问题

### Q1: 工具注册了但没有输出
**原因**：权限被拒绝或工具执行失败
**解决**：查看日志中的 `❌` 错误信息

### Q2: 只有 RSS 没有日历和天气
**原因**：日历和天气工具执行失败（权限或网络问题）
**解决**：
- 检查权限设置
- 检查网络连接（天气需要访问 Open-Meteo API）
- 查看错误日志

### Q3: 日志显示工具未注册
**原因**：工具注册在异步 Task 中，还没完成
**解���**：使用本次修复的同步注册方式

## 测试步骤

1. **清理并重新编译**
   ```bash
   cd PodcastApp
   swift build
   ```

2. **运行应用**
   - 打开应用
   - 查看控制台日志，确认看到 "已注册 4 个工具"

3. **授予权限**
   - 首次使用时会弹出权限请求
   - 允许日历和位置权限

4. **生成播客**
   - 点击生成播客
   - 查看控制台日志，确认工具执行成功
   - 查看 LLM Prompt，确认包含【情境上下文】

5. **验证结果**
   - 播客脚本应该提到天气和日程
   - 例如："今天天气不错，22度，适合出门。对了，你今天有个团队站会..."

## 下一步优化

如果仍然有问题，可以：

1. **添加更详细的错误处理**
   - 在工具执行失败时显示用户友好的提示
   - 例如："无法获取日历信息，请检查权限设置"

2. **添加重试机制**
   - 网络请求失败时自动重试
   - 权限被拒绝时提示用户手动授权

3. **添加降级策略**
   - 如果日历和天气都失败，至少保证 RSS 可用
   - 在 UI 上显示哪些工具可用/不可用
