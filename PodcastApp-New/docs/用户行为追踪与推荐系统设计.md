# 用户行为追踪与推荐系统设计文档

## 概述

本文档描述了播客应用的用户行为追踪系统和推荐策略设计。通过全面记录用户行为，我们可以构建精准的用户画像，实现个性化的内容推荐。

---

## 一、数据模型架构

### 1.1 核心数据模型

#### 1. UserBehaviorEvent（用户行为事件）

**用途**：记录所有用户行为的通用事件日志

**字段说明**：
```swift
- id: UUID                    // 事件唯一标识
- eventType: String           // 事件类型（见下方枚举）
- timestamp: Date             // 事件发生时间
- podcastId: UUID?            // 关联的播客ID
- topicName: String?          // 关联的话题名称
- detailsData: Data?          // 事件详情（JSON格式）
```

**支持的事件类型**：
- **播放行为**：
  - `play_start` - 开始播放
  - `play_pause` - 暂停播放
  - `play_resume` - 恢复播放
  - `play_complete` - 播放完成
  - `play_exit` - 中途退出
  - `play_seek` - 跳转播放位置
  - `play_speed_change` - 改变播放速度

- **浏览行为**：
  - `podcast_view` - 查看播客详情
  - `podcast_list_browse` - 浏览播客列表
  - `topic_view` - 查看话题

- **生成行为**：
  - `podcast_generate` - 生成播客
  - `podcast_generate_complete` - 生成完成

- **话题管理**：
  - `topic_add` - 添加话题
  - `topic_remove` - 删除话题
  - `topic_priority_change` - 调整话题优先级

- **聊天交互**：
  - `chat_send` - 发送聊天消息
  - `chat_with_context` - 带播客上下文的聊天

- **配置变更**：
  - `config_change` - 配置变更

**使用场景**：
- 用户行为分析
- 行为序列分析
- 异常行为检测
- A/B测试数据收集

---

#### 2. PlaybackSession（播放会话）

**用途**：记录一次完整的播放行为，包含详细的播放特征

**字段说明**：
```swift
- id: UUID                    // 会话唯一标识
- podcastId: UUID             // 播客ID
- podcastTitle: String        // 播客标题
- podcastTopics: [String]     // 播客话题标签

// 时间信息
- startTime: Date             // 会话开始时间
- endTime: Date?              // 会话结束时间
- totalDuration: Int          // 播客总时长（秒）

// 播放行为
- playedDuration: Int         // 实际播放时长（秒）
- completionRate: Double      // 完播率 (0.0-1.0)
- startPosition: Double       // 开始播放位置（秒）
- endPosition: Double         // 结束播放位置（秒）
- maxPosition: Double         // 播放到的最远位置（秒）

// 播放特征
- pauseCount: Int             // 暂停次数
- seekCount: Int              // 跳转次数
- playbackSpeed: Double       // 播放速度
- isCompleted: Bool           // 是否完播

// 跳过的段落
- skippedSegmentsData: Data?  // [[startTime, endTime]]
```

**兴趣等级判定**：
- `high` (高兴趣)：完播率 ≥ 80%
- `medium` (中等兴趣)：完播率 50-80%
- `low` (低兴趣)：完播率 20-50%
- `veryLow` (很低兴趣)：完播率 < 20%

**关键指标**：
1. **完播率**：最重要的兴趣指标
2. **暂停次数**：高暂停次数可能表示内容引发思考或不够流畅
3. **跳转次数**：频繁跳转可能表示寻找感兴趣的内容
4. **跳过段落**：记录用户快进跳过的时间段，用于内容优化
5. **播放速度**：1.5x/2x可能表示熟悉该话题或时间紧张

**使用场景**：
- 计算话题偏好
- 分析内容质量
- 优化播客生成策略
- 识别高价值内容

---

#### 3. ContentInteraction（内容交互）

**用途**：记录用户与内容的各种交互行为

**字段说明**：
```swift
- id: UUID                    // 交互唯一标识
- interactionType: String     // 交互类型（见下方枚举）
- timestamp: Date             // 交互时间

// 内容信息
- contentType: String         // 内容类型："podcast", "topic", "chat"
- contentId: UUID?            // 内容ID
- contentTitle: String?       // 内容标题

// 上下文信息
- sourceScreen: String?       // 来源页面
- topicTags: [String]         // 关联的话题标签

// 交互详情
- durationSeconds: Int?       // 交互时长（秒）
- detailsData: Data?          // 额外详情
```

**交互类型**：
- `view` - 查看
- `click` - 点击
- `generate` - 生成
- `delete` - 删除
- `share` - 分享
- `favorite` - 收藏

**使用场景**：
- 追踪用户浏览路径
- 分析内容吸引力
- 优化UI/UX设计
- 个性化内容排序

---

#### 4. TopicPreference（话题偏好）

**用途**：聚合统计用户对各个话题的偏好程度

**字段说明**：
```swift
- id: UUID                    // 偏好记录唯一标识
- topicName: String           // 话题名称
- lastUpdated: Date           // 最后更新时间

// 播放统计
- totalPlays: Int             // 总播放次数
- completedPlays: Int         // 完播次数
- averageCompletionRate: Double // 平均完播率
- totalPlayTime: Int          // 总播放时长（秒）

// 生成统计
- totalGenerations: Int       // 总生成次数
- playedGenerations: Int      // 生成后播放的次数

// 交互统计
- viewCount: Int              // 查看次数
- chatMentionCount: Int       // 聊天中提及次数

// 时间统计
- firstInteractionDate: Date? // 首次交互时间
- lastInteractionDate: Date?  // 最近交互时间
- recentPlayCount: Int        // 最近7天播放次数

// 偏好评分（0-100）
- preferenceScore: Double     // 综合偏好评分
```

**偏好评分算法**：
```
总分 = 100分

1. 完播率权重：40分
   score += averageCompletionRate * 40

2. 播放频率权重：30分
   playFrequency = min(totalPlays / 10.0, 1.0)  // 10次以上满分
   score += playFrequency * 30

3. 生成转化率权重：15分
   conversionRate = playedGenerations / totalGenerations
   score += conversionRate * 15

4. 聊天提及权重：10分
   chatScore = min(chatMentionCount / 5.0, 1.0)  // 5次以上满分
   score += chatScore * 10

5. 最近活跃度权重：5分
   if daysSinceLastInteraction < 7:
       score += 5.0
   elif daysSinceLastInteraction < 30:
       score += 2.5
```

**偏好等级**：
- 80-100分：非常感兴趣
- 60-79分：比较感兴趣
- 40-59分：一般
- 20-39分：不太感兴趣
- 0-19分：不感兴趣

**使用场景**：
- 话题推荐排序
- 自动生成播客的话题选择
- 用户画像构建
- 内容个性化

---

### 1.2 现有数据模型（已存在）

#### 5. ListeningHistory（收听历史）

**用途**：简化的收听记录，用于历史展示

**字段说明**：
```swift
- id: UUID
- podcastId: UUID
- podcastTitle: String
- listenedAt: Date
- duration: Int               // 收听时长（秒）
- completionRate: Double      // 完播率 (0.0-1.0)
```

**与PlaybackSession的关系**：
- ListeningHistory：简化版，用于UI展示
- PlaybackSession：详细版，用于数据分析

---

#### 6. ChatMessage（聊天消息）

**用途**：记录用户与AI的对话

**字段说明**：
```swift
- id: UUID
- content: String
- role: String                // "user" 或 "assistant"
- timestamp: Date

// 上下文信息
- podcastId: UUID?            // 关联的播客ID
- podcastTitle: String?       // 播客标题
- playbackTime: Double?       // 提问时的播放位置（秒）
- contextSegmentsData: Data?  // 相关的脚本段落
```

**使用场景**：
- 提取用户兴趣话题
- 理解用户需求
- 优化对话体验
- 生成个性化内容

---

## 二、数据流与追踪点

### 2.1 播放行为追踪流程

```
用户点击播放
    ↓
创建 PlaybackSession
记录 UserBehaviorEvent (play_start)
    ↓
播放过程中
    ├─ 实时更新播放进度
    ├─ 记录暂停 → UserBehaviorEvent (play_pause)
    ├─ 记录恢复 → UserBehaviorEvent (play_resume)
    ├─ 记录跳转 → UserBehaviorEvent (play_seek) + 记录跳过段落
    └─ 记录速度变化 → UserBehaviorEvent (play_speed_change)
    ↓
播放结束
    ├─ 完播 → UserBehaviorEvent (play_complete)
    └─ 中途退出 → UserBehaviorEvent (play_exit)
    ↓
结束 PlaybackSession
    ├─ 计算完播率、兴趣等级
    ├─ 更新 TopicPreference（所有相关话题）
    └─ 创建 ListeningHistory
```

### 2.2 话题管理追踪流程

```
添加话题
    ↓
记录 UserBehaviorEvent (topic_add)
创建/更新 TopicPreference
    ↓
删除话题
    ↓
记录 UserBehaviorEvent (topic_remove)
降低 TopicPreference.preferenceScore（-50分）
```

### 2.3 内容生成追踪流程

```
生成播客
    ↓
记录 UserBehaviorEvent (podcast_generate)
记录 ContentInteraction (generate)
更新 TopicPreference.totalGenerations
    ↓
用户播放生成的播客
    ↓
更新 TopicPreference.playedGenerations
计算生成转化率
```

### 2.4 聊天交互追踪流程

```
用户发送消息
    ↓
提取消息中的话题关键词
    ↓
记录 UserBehaviorEvent (chat_send 或 chat_with_context)
    ↓
更新相关话题的 TopicPreference.chatMentionCount
```

---

## 三、推荐策略设计

### 3.1 基于偏好评分的话题推荐

**策略**：根据TopicPreference.preferenceScore排序

**实现**：
```swift
func getRecommendedTopics(limit: Int = 10) -> [String] {
    let preferences = behaviorTracker.getTopicPreferences(limit: limit)
    return preferences
        .filter { $0.preferenceScore >= 40 }  // 过滤掉不感兴趣的
        .map { $0.topicName }
}
```

**优化方向**：
1. 考虑话题新鲜度（避免推荐过度消费的话题）
2. 引入话题多样性（避免推荐过于集中）
3. 考虑时间衰减（最近的行为权重更高）

---

### 3.2 基于完播率的内容质量优化

**策略**：分析PlaybackSession的完播率和跳过段落

**实现思路**：
```swift
// 1. 分析低完播率的播客
func analyzeLowCompletionPodcasts() {
    let sessions = behaviorTracker.getRecentPlaybackSessions(limit: 100)
    let lowCompletionSessions = sessions.filter { $0.completionRate < 0.5 }

    // 分析共同特征
    // - 话题组合
    // - 内容深度
    // - 主播风格
    // - 播客时长
}

// 2. 分析跳过的段落
func analyzeSkippedSegments() {
    // 识别经常被跳过的内容类型
    // 优化脚本生成策略
}
```

**优化方向**：
1. 识别高质量内容的特征
2. 优化低质量内容的生成参数
3. 调整播客时长
4. 优化脚本结构

---

### 3.3 基于行为序列的智能推荐

**策略**：分析用户的行为模式，预测下一步需求

**行为模式示例**：
```
模式1：深度学习者
- 高完播率（>80%）
- 低播放速度（1.0x）
- 高暂停次数（思考）
- 频繁提问
→ 推荐：深度分析内容，相关话题的进阶内容

模式2：快速浏览者
- 中等完播率（50-70%）
- 高播放速度（1.5x-2.0x）
- 低暂停次数
- 频繁跳转
→ 推荐：快速浏览内容，多样化话题

模式3：选择性收听者
- 低完播率（<50%）
- 频繁跳转
- 明确的跳过段落
→ 推荐：精准匹配兴趣点，缩短播客时长
```

---

### 3.4 基于时间模式的推送策略

**策略**：分析用户的收听时间习惯，优化推送时机

**实现思路**：
```swift
func analyzeListeningTimePatterns() -> TimePattern {
    let sessions = behaviorTracker.getRecentPlaybackSessions(limit: 100)

    // 分析收听时间分布
    let hourDistribution = sessions.map {
        Calendar.current.component(.hour, from: $0.startTime)
    }

    // 识别高峰时段
    let peakHours = findPeakHours(hourDistribution)

    // 识别工作日 vs 周末习惯
    let weekdayPattern = analyzeWeekdayPattern(sessions)

    return TimePattern(peakHours: peakHours, weekdayPattern: weekdayPattern)
}
```

**优化方向**：
1. 在用户活跃时段前生成内容
2. 根据时段推荐不同类型的内容（早晨：新闻，晚上：深度）
3. 优化自动生成的时间设置

---

## 四、下一步优化建议

### 4.1 短期优化（1-2周）

#### 1. 完善数据收集
- [ ] 添加播客卡片点击追踪
- [ ] 记录用户在列表中的滚动深度
- [ ] 追踪播客分享行为
- [ ] 记录用户对推荐内容的反馈

#### 2. 基础推荐功能
- [ ] 实现基于TopicPreference的话题排序
- [ ] 在首页展示"为你推荐"板块
- [ ] 根据偏好评分自动调整话题优先级
- [ ] 实现"相似话题"推荐

#### 3. 数据可视化
- [ ] 创建"我的收听统计"页面
  - 总收听时长
  - 最喜欢的话题（Top 5）
  - 收听时间分布图
  - 完播率趋势
- [ ] 话题偏好雷达图
- [ ] 收听习惯分析

---

### 4.2 中期优化（3-4周）

#### 1. 智能内容生成
- [ ] 根据TopicPreference自动选择生成话题
- [ ] 根据用户行为模式调整生成参数
  - 深度学习者 → 深度分析 + 长时长
  - 快速浏览者 → 快速浏览 + 短时长
- [ ] 实现"智能混合"模式（多个高分话题组合）

#### 2. 内容质量优化
- [ ] 分析低完播率播客的共同特征
- [ ] 识别经常被跳过的内容段落
- [ ] 优化脚本生成prompt
- [ ] A/B测试不同的生成策略

#### 3. 个性化推荐算法
- [ ] 实现协同过滤（如果有多用户）
- [ ] 基于内容的推荐（相似话题、相似风格）
- [ ] 混合推荐策略
- [ ] 冷启动问题处理（新用户推荐）

---

### 4.3 长期优化（1-2个月）

#### 1. 高级用户画像
- [ ] 使用LLM分析聊天内容，提取深层兴趣
- [ ] 构建多维度用户画像
  - 兴趣维度（话题偏好）
  - 行为维度（收听模式）
  - 时间维度（活跃时段）
  - 内容维度（深度偏好、风格偏好）
- [ ] 用户分群（深度学习者、快速浏览者等）

#### 2. 预测性推荐
- [ ] 预测用户下一步可能感兴趣的话题
- [ ] 预测最佳推送时间
- [ ] 预测播客完播概率
- [ ] 主动生成高概率完播的内容

#### 3. 反馈循环优化
- [ ] 实现显式反馈机制（点赞/点踩）
- [ ] 根据反馈实时调整推荐策略
- [ ] 实现推荐解释功能（"为什么推荐这个"）
- [ ] 持续监控推荐效果指标

#### 4. 高级分析功能
- [ ] 话题趋势分析（兴趣变化）
- [ ] 内容消费模式分析
- [ ] 异常行为检测（兴趣突变）
- [ ] 用户留存分析

---

## 五、关键指标（KPI）

### 5.1 用户参与度指标
- **日活跃用户数（DAU）**
- **周活跃用户数（WAU）**
- **平均每日收听时长**
- **平均每周收听次数**

### 5.2 内容质量指标
- **平均完播率**：目标 >70%
- **高完播率播客占比**：目标 >60%
- **生成转化率**：生成后被播放的比例，目标 >80%
- **重复收听率**：同一播客被多次播放的比例

### 5.3 推荐效果指标
- **推荐点击率（CTR）**：推荐内容被点击的比例
- **推荐完播率**：推荐内容的完播率 vs 整体完播率
- **话题覆盖度**：用户实际收听的话题数 / 添加的话题数
- **新话题发现率**：用户通过推荐发现新话题的比例

### 5.4 用户满意度指标
- **用户留存率**：7日留存、30日留存
- **内容生成频率**：用户主动生成内容的频率
- **聊天互动频率**：用户与AI对话的频率
- **话题管理活跃度**：添加/删除话题的频率

---

## 六、技术实现要点

### 6.1 性能优化
```swift
// 1. 批量更新TopicPreference
func batchUpdateTopicPreferences(sessions: [PlaybackSession]) {
    // 避免每次播放都单独更新
    // 定期批量更新（如每小时）
}

// 2. 异步数据分析
Task.detached {
    await analyzeUserBehavior()
}

// 3. 缓存推荐结果
private var cachedRecommendations: [String]?
private var cacheTimestamp: Date?

func getRecommendations() -> [String] {
    if let cached = cachedRecommendations,
       let timestamp = cacheTimestamp,
       Date().timeIntervalSince(timestamp) < 3600 {  // 1小时缓存
        return cached
    }

    let recommendations = calculateRecommendations()
    cachedRecommendations = recommendations
    cacheTimestamp = Date()
    return recommendations
}
```

### 6.2 数据隐私
- 所有数据本地存储（SwiftData）
- 不上传用户行为数据
- 用户可以清除历史数据
- 提供数据导出功能

### 6.3 数据清理策略
```swift
// 定期清理旧数据（保留最近3个月）
func cleanOldData() {
    let threeMonthsAgo = Calendar.current.date(byAdding: .month, value: -3, to: Date())!

    // 清理旧的UserBehaviorEvent
    let oldEvents = try? modelContext.fetch(
        FetchDescriptor<UserBehaviorEvent>(
            predicate: #Predicate { $0.timestamp < threeMonthsAgo }
        )
    )
    oldEvents?.forEach { modelContext.delete($0) }

    // 清理旧的PlaybackSession
    // ...
}
```

---

## 七、测试与验证

### 7.1 数据完整性测试
- [ ] 验证所有关键行为都被正确记录
- [ ] 验证数据关联关系正确
- [ ] 验证偏好评分计算准确

### 7.2 推荐效果测试
- [ ] A/B测试不同推荐策略
- [ ] 对比推荐内容 vs 非推荐内容的完播率
- [ ] 用户满意度调查

### 7.3 性能测试
- [ ] 大量数据下的查询性能
- [ ] 推荐算法的响应时间
- [ ] 内存占用情况

---

## 八、总结

这套用户行为追踪系统为播客应用提供了全面的数据基础，通过：

1. **多层次数据模型**：从原始事件到聚合统计
2. **全面的行为追踪**：覆盖播放、浏览、生成、聊天等所有关键行为
3. **智能偏好计算**：综合多个维度计算话题偏好评分
4. **灵活的推荐策略**：支持多种推荐算法和优化方向

**核心优势**：
- 数据驱动的个性化体验
- 持续优化的内容质量
- 精准的用户画像
- 可量化的效果评估

**下一步重点**：
1. 完善数据收集（短期）
2. 实现基础推荐功能（短期）
3. 优化内容生成策略（中期）
4. 构建预测性推荐系统（长期）

通过持续迭代和优化，这套系统将帮助应用实现真正的个性化和智能化。
