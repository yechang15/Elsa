# 播客定期调度功能说明

## 功能概述

已实现播客自动生成的定期调度功能，可以在指定时间自动生成播客内容。

## 实现内容

### 1. 调度服务 (SchedulerService)

新增 `SchedulerService.swift` 文件，提供以下功能：

- **定时检查**：每分钟检查一次是否到达设定的生成时间
- **频率控制**：支持每天、工作日、周末等不同生成频率
- **防重复生成**：记录每天的生成状态，避免重复生成
- **本地通知**：生成完成后发送系统通知
- **状态管理**：实时显示调度器运行状态和下次生成时间

### 2. 主要功能

#### 时间调度
- 根据用户设置的时间（如 07:00）自动触发生成
- 支持的频率：
  - 每天生成
  - 工作日生成（周一至周五）
  - 周末生成（周六、周日）
  - 自定义周期（可扩展）

#### 智能检查
- 检查是否到达设定时间（精确到分钟）
- 检查今天是否已经生成过
- 检查是否符合设定的生成频率

#### 通知功能
- 生成成功时发送通知，显示播客标题
- 生成失败时发送错误通知

#### 自动播放
- 播客生成完成后自动开始播放
- 无需手动点击播放按钮
- 适用于手动生成和自动调度生成

### 3. 集成方式

#### 应用启动时
在 `PodcastApp.swift` 中，应用启动时自动启动调度器：

```swift
.onAppear {
    schedulerService.start(
        appState: appState,
        podcastService: podcastService,
        modelContext: modelContainer.mainContext
    )
}
```

#### 设置更改时
当用户在设置界面修改以下配置时，调度器会自动重启：
- 开启/关闭自动生成
- 修改生成时间
- 修改生成频率

### 4. 用户界面

在设置界面的"播客生成配置"部分，新增了调度器状态显示：

- 🟢 调度器运行中 / ⚪ 调度器已停止
- 显示下次生成时间（如：下次生成: 2月20日 上午7:00）

## 使用方法

1. **打开设置**：在应用中打开设置界面
2. **配置自动生成**：
   - 开启"自动生成"开关
   - 选择生成频率（每天/工作日/周末）
   - 设置生成时间（0-23点）
3. **查看状态**：在设置界面可以看到调度器运行状态和下次生成时间
4. **等待生成**：应用会在设定时间自动生成播客
5. **接收通知**：生成完成后会收到系统通知

## 注意事项

1. **应用需要保持运行**：
   - macOS 应用需要在后台运行才能触发定时任务
   - 如果应用完全退出，调度器会停止工作

2. **通知权限**：
   - 首次使用时会请求通知权限
   - 建议允许通知以便及时了解生成状态

3. **防重复机制**：
   - 每天只会生成一次播客
   - 即使多次到达设定时间，也不会重复生成

4. **配置要求**：
   - 需要先配置好 LLM API Key
   - 需要至少有一个主题
   - 主题需要关联有效的 RSS 源

## 技术细节

### 定时器实现
使用 `Timer.scheduledTimer` 每分钟检查一次，避免频繁检查消耗资源。

### 时间判断
精确到分钟级别，在目标时间的当前分钟内触发生成。

### 状态持久化
使用 `UserDefaults` 记录最后生成时间，应用重启后仍然有效。

### 通知中心
使用 `NotificationCenter` 实现设置界面和主应用之间的通信。

## 未来扩展

可以考虑添加以下功能：
- 支持多个生成时间点
- 支持更复杂的自定义周期（如每周三、每月1号等）
- 支持后台任务（即使应用退出也能生成）
- 支持生成历史记录和统计
