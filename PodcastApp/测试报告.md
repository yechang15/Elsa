# 火山引擎双向流式TTS集成完成报告

## 测试状态

✅ 代码已完成并编译成功
✅ 应用已启动运行
⏳ 等待用户在应用中进行实际测试

## 已提供的测试凭证

```
App ID: YOUR_APP_ID
Access Token: YOUR_ACCESS_TOKEN
Secret Key: 7G1pJULkxTukvFtpwwJGe19ivKDv6Q8- (未使用，文档中未要求)
Resource ID: seed-tts-2.0 (推荐)
```

## 测试步骤

1. 打开应用，进入"设置"页面
2. 选择TTS引擎为"豆包语音合成2.0"
3. 填写配置信息：
   - App ID: `YOUR_APP_ID`
   - Access Token: `YOUR_ACCESS_TOKEN`
   - Resource ID: 选择"豆包语音合成2.0"
   - 主播A语音ID: `zh_female_tianmeixiaoyuan`
   - 主播B语音ID: `zh_male_aojiaobazong`
4. 点击"测试TTS"按钮
5. 等待测试结果并听取播放的音频

## 实现要点

### 1. 二进制帧格式（已修正）

根据火山引擎文档，正确的帧格式为：

```
[Header 4字节] + [Event Number 4字节] + [Payload Size 4字节] + [Payload JSON]
```

Header结构：
- Byte 0: `0x11` (v1, 4-byte header)
- Byte 1: `0x14` (Full-client request, with event number)
- Byte 2: `0x10` (JSON, no compression)
- Byte 3: `0x00` (Reserved)

### 2. Event Codes

```swift
StartConnection = 1
FinishConnection = 2
ConnectionStarted = 50
ConnectionFinished = 52
StartSession = 100
FinishSession = 102
SessionStarted = 150
SessionFinished = 152
TaskRequest = 200
AudioData = 250
Error = 300
```

### 3. Payload格式

StartSession payload:
```json
{
  "event": 100,
  "namespace": "BidirectionalTTS",
  "req_params": {
    "text": "",
    "speaker": "zh_female_tianmeixiaoyuan",
    "audio_params": {
      "format": "mp3",
      "sample_rate": 24000,
      "speech_rate": 0
    }
  }
}
```

TaskRequest payload:
```json
{
  "event": 200,
  "namespace": "BidirectionalTTS",
  "req_params": {
    "text": "要合成的文本"
  }
}
```

## 已知问题

1. ⚠️ WebSocket握手可能失败 - 需要实际测试验证凭证是否正确
2. ⚠️ 音频数据格式 - 假设返回的是Base64编码的MP3，需要实际测试验证
3. ⚠️ Event codes - 根据文档推测，可能需要调整

## 下一步

请在应用中进行实际测试，如果遇到错误，请提供：
1. 控制台输出的错误信息
2. 应用日志 (`/tmp/podcast_test.log`)
3. 具体的错误描述

我会根据实际测试结果进行调整。

## 文件清单

### 新增文件
- `PodcastApp/Services/TTS/VolcengineBidirectionalTTS.swift` - 核心实现
- `PodcastApp/Services/TTS/VolcengineTTSTest.swift` - 测试工具类
- `火山引擎TTS集成说明.md` - 使用文档

### 修改文件
- `AppState.swift` - 添加配置项
- `TTSService.swift` - 集成新TTS引擎
- `SettingsView.swift` - 添加配置界面和测试按钮
- `PodcastService.swift` - 更新调用参数
- `AudioPlayer.swift` - 修复废弃API警告

## 音色推荐

根据文档，推荐使用以下音色：
- 女声：`zh_female_tianmeixiaoyuan`、`zh_female_shuangkuaisisi_moon_bigtts`
- 男声：`zh_male_aojiaobazong`、`zh_male_wennuanahu_moon_bigtts`

完整音色列表：https://www.volcengine.com/docs/6561/1257544
