# Memory 功能设计方案

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                        用户交互层                                                                      │
│                                          Chat 对话  │  播客收听  │  话题选择  │  记忆编辑                                              │
└────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────────┘
                                                             │
                    ┌────────────────────────────────────────┼────────────────────────────────────────┐
                    │                                        │                                        │
                    ▼                                        ▼                                        ▼
        ┌──────────────────────┐              ┌──────────────────────────┐              ┌──────────────────────┐
        │  BehaviorTracker     │              │     ChatService          │              │   用户主动输入        │
        │    (行为追踪)         │              │     (对话分析)           │              │   (话题/偏好)         │
        │                      │              │                          │              │                      │
        │ • 播放次数           │              │ • 对话内容提取           │              │ • 话题选择           │
        │ • 收听时长           │              │ • 目标识别               │              │ • 手动编辑记忆       │
        │ • 跳过/重听          │              │ • 风格偏好               │              │ • 设置调整           │
        │ • 话题权重           │              │ • 长期特征               │              │                      │
        └──────────┬───────────┘              └────────────┬─────────────┘              └──────────┬───────────┘
                   │                                       │                                       │
                   │ 每10次播放触发                         │ 对话结束后提取                         │ 实时写入
                   │                                       │                                       │
                   └───────────────────────────────────────┼───────────────────────────────────────┘
                                                           │
                                                           ▼
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                    MemoryManager (记忆管理中心)                                                         │
│                                                                                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                              记忆更新引擎                                                                       │   │
│  │                                                                                                                               │   │
│  │         LLM 智能提取与压缩  │  自动触发机制（播放次数、时间间隔）  │  手动编辑支持  │  自动降级（无 LLM 时用规则）            │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                           │                                                                          │
│                                                           ▼                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                            记忆文件系统 (/memory)                                                              │   │
│  │                                                                                                                               │   │
│  │    ┌──────────────────┐      ┌──────────────────┐      ┌──────────────────┐      ┌──────────────────────────────────────┐   │   │
│  │    │  profile.md      │      │ preferences.md   │      │   goals.md       │      │   memory_summary.md              │   │   │
│  │    │                  │      │                  │      │                  │      │                                  │   │   │
│  │    │ 长期稳定人格信息  │      │ 播客偏好(核心)    │      │ 阶段目标         │      │ 整体摘要(300字内)                 │   │   │
│  │    │                  │      │                  │      │                  │      │                                  │   │   │
│  │    │ • 职业/背景      │      │ • 话题评分       │      │ • 学习目标       │      │ 聚合 profile + preferences +     │   │   │
│  │    │ • 性格特征       │      │ • 内容风格       │      │ • 成长方向       │      │ goals，LLM 压缩生成              │   │   │
│  │    │ • 沟通风格       │      │ • 时长偏好       │      │ • 时间规划       │      │                                  │   │   │
│  │    │                  │      │ • 语速/语气      │      │                  │      │ 用于播客生成和对话上下文          │   │   │
│  │    │ 来源: Chat对话   │      │ 来源: 行为追踪   │      │ 来源: Chat对话   │      │                                  │   │   │
│  │    │ 更新: 极低频     │      │ 更新: 每10次播放 │      │ 更新: 中频       │      │ 来源: 自动聚合                   │   │   │
│  │    └──────────────────┘      └──────────────────┘      └──────────────────┘      └──────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────┘
                                                               │
                                                               │ 记忆应用
                                                               │
                    ┌──────────────────────────────────────────┼──────────────────────────────────────────┐
                    │                                          │                                          │
                    ▼                                          ▼                                          ▼
        ┌──────────────────────┐              ┌──────────────────────────┐              ┌──────────────────────┐
        │  播客脚本生成         │              │     Chat 对话            │              │    推荐系统          │
        │                      │              │                          │              │                      │
        │ • 注入 summary.md    │              │ • 上下文感知             │              │ • 话题权重调整       │
        │ • 个性化内容         │              │ • 记忆检索               │              │ • 内容过滤           │
        │ • 风格适配           │              │ • 连续对话               │              │ • 自动推荐           │
        └──────────────────────┘              └──────────────────────────┘              └──────────────────────┘
```

## 数据流向说明

**记忆采集 → 更新 → 应用** 的完整流程：

1. **采集阶段**：用户行为（播放、对话、选择）→ 数据源（BehaviorTracker / ChatService / 用户输入）
2. **更新阶段**：MemoryManager 通过 LLM 提取关键信息 → 写入对应记忆文件 → 自动生成摘要
3. **应用阶段**：播客生成/Chat 对话读取记忆 → 个性化内容输出 → 用户体验提升 → 新的行为数据 → 循环优化

---

## 一、核心原则

**记忆 ≠ 对话日志**
**记忆 = 长期个性化信息的结构化摘要**

只保留对未来播客生成有价值的信息。

---

## 二、文件结构（MVP 版）

```
/memory
  ├── profile.md          # 长期稳定的人格信息
  ├── preferences.md      # 播客偏好（核心文件）
  ├── goals.md           # 当前阶段目标
  └── memory_summary.md  # 整体画像摘要（300字内）
```

---

## 三、各文件详解

### 1. profile.md - 长期稳定信息

**核心作用**：记录用户基本背景和长期不变的特征

**示例内容**：
```markdown
# User Profile

## Background
- 职业：互联网产品经理，5年经验
- 教育背景：计算机科学本科
- 年龄段：30-35岁

## Core Interests (长期兴趣)
- 人工智能与机器学习
- 创业与商业模式
- 科技产品设计

## Personality Traits (性格特征)
- 理性思维为主，喜欢数据和逻辑
- 追求效率，时间观念强
- 好奇心强，喜欢探索新事物

## Communication Style (沟通风格)
- 喜欢结构清晰的内容
- 不喜欢过度煽情或夸张的表达
- 偏好直接、简洁的信息传递
```

**更新频率**：极低（几个月甚至一年）
**触发条件**：用户明确表达长期特征变化

---

### 2. preferences.md - 播客偏好（最核心）

**核心作用**：生成个性化播客的直接依据

**示例内容**：
```markdown
# Podcast Preferences

## Topic Preferences (话题偏好)
### 强烈感兴趣 (80-100分)
- AI技术发展与应用 (95分)
- 创业案例分析 (88分)
- 产品设计方法论 (85分)

### 比较感兴趣 (60-80分)
- 科技行业动态 (72分)
- 心理学与认知科学 (68分)

### 不感兴趣 (0-40分)
- 娱乐八卦 (15分)
- 体育赛事 (20分)

## Format Preferences (形式偏好)
- ✅ 喜欢：双人对话形式（完播率85%）
- ✅ 喜欢：案例分析 + 观点讨论（完播率82%）
- ❌ 不喜欢：单人独白（完播率45%）
- ❌ 不喜欢：多人圆桌（完播率50%）

## Tone & Style (语气风格)
- 偏好理性、客观的分析
- 不喜欢过度煽情或鸡汤式内容
- 喜欢有数据支撑的论述
- 接受适度幽默，但不要刻意搞笑

## Length Preferences (时长偏好)
- 理想时长：15-20分钟
- 可接受：10-25分钟
- 太短（<10分钟）：感觉不够深入
- 太长（>30分钟）：难以完整听完（完播率仅35%）

## Pacing Preferences (节奏偏好)
- 喜欢紧凑的节奏，信息密度高
- 经常使用1.5x播放速度
- 会跳过冗长的开场白（前30秒常被跳过）
- 会跳过重复性总结

## Content Depth (内容深度)
- 偏好有深度的分析，而非浅层科普
- 喜欢听到不同观点的碰撞
- 希望有可操作的启发，而非纯理论

## Avoid Topics (明确不喜欢)
- 娱乐明星八卦
- 过度营销性质的内容
- 阴谋论或伪科学
```

**更新频率**：高（每5-10次播放后可能更新）
**数据来源**：
- TopicPreference 的 preferenceScore
- PlaybackSession 的完播率、跳过段落
- 用户在聊天中的明确表达

---

### 3. goals.md - 当前阶段目标

**核心作用**：记录动态目标，让内容对当前阶段有用

**示例内容**：
```markdown
# Current Goals

## Learning Goals (学习目标)
- 系统学习大语言模型的原理和应用（2024年Q1-Q2）
- 了解 AI Agent 的设计模式
- 学习 Prompt Engineering 技巧

## Career Goals (职业目标)
- 准备在1年内创业，方向是 AI 应用产品
- 需要积累 AI 产品的实战经验
- 寻找潜在的联合创始人

## Short-term Needs (短期需求)
- 正在准备一个产品 Demo，需要技术选型建议
- 想了解 AI 创业的融资环境
- 需要时间管理方面的建议

## Life Stage (生活阶段)
- 工作日通勤时间：每天1小时（主要听播客时间）
- 周末有更多时间深度学习
- 最近工作压力较大，需要平衡
```

**更新频率**：中等（1-2个月）
**触发条件**：用户表达阶段性目标变化

---

### 4. memory_summary.md - 整体画像摘要

**核心作用**：节省 token，生成播客时优先读取

**示例内容**：
```markdown
# User Memory Summary

## 一句话画像
30多岁的互联网产品经理，理性思维，正在准备 AI 方向创业，偏好高信息密度的深度内容。

## 核心特征
- **职业背景**：产品经理，有技术背景
- **当前目标**：学习 AI 技术，准备创业
- **内容偏好**：AI、创业、产品设计（深度分析）
- **形式偏好**：双人对话，15-20分钟，1.5x速度
- **风格偏好**：理性、数据驱动、高信息密度
- **明确排斥**：娱乐八卦、鸡汤、伪科学

## 生成建议
- 话题选择：优先 AI 技术应用、创业案例、产品方法论
- 内容深度：中高深度，避免浅层科普
- 对话风格：理性讨论，适度幽默，有数据支撑
- 时长控制：15-20分钟最佳
- 节奏：紧凑，信息密度高，减少冗余

最后更新：2024-02-20
```

**更新频率**：每次更新其他文件后自动重新生成

---

## 四、各文件更新机制 & 使用机制（详细）

> 说明：`[已实现]` = 代码已存在；`[待实现]` = 尚未开发

---

### profile.md

#### 更新机制
| 项目 | 说明 |
|------|------|
| 触发方式 | 手动触发（用户在聊天中明确表达长期特征） |
| 数据来源 | 聊天对话内容（ChatMessage） |
| 更新频率 | 极低，几个月甚至一年一次 |
| 更新逻辑 | LLM 分析对话，判断是否有值得写入的长期特征，有则覆盖写入 |
| 当前状态 | `[待实现]` 目前只有文件读写接口，无自动更新逻辑 |

**触发示例**：
- 用户说"我是做产品的" → 写入 Background
- 用户说"我一直对 AI 很感兴趣" → 写入 Core Interests
- 用户说"今天心情不好" → ❌ 不触发（非长期特征）

#### 使用机制
| 项目 | 说明 |
|------|------|
| 读取时机 | 生成播客时（可选，作为补充上下文） |
| 注入位置 | LLM prompt 的背景信息部分 |
| 优先级 | 低（memory_summary.md 已包含核心信息，profile 提供细节） |
| 当前状态 | `[待实现]` 目前生成播客只注入 summary，未单独注入 profile |

---

### preferences.md

#### 更新机制
| 项目 | 说明 |
|------|------|
| 触发方式 | 自动触发（基于行为数据） + 手动触发（UI 按钮） |
| 数据来源 | `TopicPreference`（偏好评分）、`PlaybackSession`（完播率、播放速度、跳过段落） |
| 更新频率 | 高，每 5-10 次播放后建议更新一次 |
| 更新逻辑 | `MemoryManager.generatePreferencesFromBehavior()` 读取行为数据，生成结构化 MD |
| 当前状态 | `[已实现]` 可通过 UI 手动触发；`[待实现]` 自动触发机制（播放次数阈值） |

**自动触发条件（待实现）**：
```
每次 endPlaybackSession 后检查：
  - 累计播放次数 % 10 == 0 → 触发更新
  - 某话题 preferenceScore 变化 > 20 分 → 触发更新
  - 用户在聊天中说"我不喜欢 XX" → 触发更新
```

#### 使用机制
| 项目 | 说明 |
|------|------|
| 读取时机 | 生成播客时（通过 `memoryManager.loadPreferences()`） |
| 注入位置 | `LLMService.buildPrompt()` 的 `memorySection` 部分 |
| 优先级 | 高（直接影响话题选择、内容深度、风格） |
| 当前状态 | `[已实现]` 生成播客时自动读取并注入到 prompt |

**注入效果**：
```
【用户偏好记忆】
# Podcast Preferences
...（preferences.md 内容）...

请根据以上用户偏好，调整播客的话题选择、内容深度、对话风格和节奏。
```

---

### goals.md

#### 更新机制
| 项目 | 说明 |
|------|------|
| 触发方式 | 手动触发（用户在聊天中表达阶段性目标） |
| 数据来源 | 聊天对话内容（ChatMessage） |
| 更新频率 | 中等，1-2 个月一次 |
| 更新逻辑 | LLM 分析对话，识别用户当前目标，覆盖写入（不追加） |
| 当前状态 | `[待实现]` 目前只有文件读写接口，无自动更新逻辑 |

**触发示例**：
- 用户说"我最近在准备考研" → 写入 Learning Goals
- 用户说"我想转行做 AI" → 写入 Career Goals
- 用户说"最近比较忙" → 写入 Life Stage（短期状态）

#### 使用机制
| 项目 | 说明 |
|------|------|
| 读取时机 | 生成播客时（可选，作为补充上下文） |
| 注入位置 | LLM prompt 的背景信息部分 |
| 优先级 | 中（帮助 LLM 选择与当前目标相关的内容角度） |
| 当前状态 | `[待实现]` 目前生成播客只注入 summary，未单独注入 goals |

---

### memory_summary.md

#### 更新机制
| 项目 | 说明 |
|------|------|
| 触发方式 | 自动触发（每次其他文件更新后自动重新生成） |
| 数据来源 | 读取 preferences.md + profile.md + goals.md，压缩合并 |
| 更新频率 | 跟随其他文件，每次有文件更新就重新生成 |
| 更新逻辑 | `MemoryManager.generateSummary()` 提取各文件关键信息，生成 300 字以内的摘要 |
| 当前状态 | `[已实现]` LLM 智能压缩版本 + 基础版本（自动降级） |

**当前实现的生成逻辑**：
```swift
// MemoryManager.generateSummary()
// 1. 检查是否有 LLM 服务
if let llmService = llmService {
    // 使用 LLM 智能压缩
    // - 读取 preferences.md + profile.md + goals.md
    // - 构建压缩 prompt（要求 300 字以内）
    // - 调用 LLM 生成结构化摘要
} else {
    // 使用基础版本（从行为数据提取）
    // - 从 TopicPreference 提取高分话题
    // - 从 PlaybackSession 提取时长、速度、完播率
    // - 生成简化的摘要
}
```

**LLM 版本的 Prompt**：
```
请将以下用户记忆压缩为 300 字以内的摘要。

重点保留：
1. 用户的核心兴趣话题（从偏好中提取高分话题）
2. 内容偏好（时长、风格、深度、节奏）
3. 当前目标和学习方向
4. 明确不喜欢的内容类型

输出格式：
- 一句话画像
- 核心特征（职业背景、当前目标、内容偏好、形式偏好、风格偏好、明确排斥）
- 生成建议（话题选择、内容深度、对话风格、时长控制、节奏）

【用户画像】
...

【播客偏好】
...

【当前目标】
...
```

#### 使用机制
| 项目 | 说明 |
|------|------|
| 读取时机 | 每次生成播客时（必读） |
| 注入位置 | `LLMService.buildPrompt()` 的 `memorySection` 部分 |
| 优先级 | 最高（90% 情况下只需要这一个文件） |
| 当前状态 | `[已实现]` 生成播客时通过 `memoryManager.loadSummary()` 读取并注入 |

---

## 五、完整数据流（当前实现）

```
用户播放播客
    ↓
AudioPlayer → BehaviorTracker.endPlaybackSession()
    ↓
更新 SwiftData：PlaybackSession + TopicPreference
    ↓
[手动触发] MemoryView 点击"从行为数据生成"
    ↓
MemoryManager.generatePreferencesFromBehavior()
    ↓
写入 preferences.md
    ↓
MemoryManager.generateSummary()
    ↓
写入 memory_summary.md
    ↓
下次生成播客时
    ↓
PodcastService 调用 memoryManager.loadSummary()
    ↓
注入到 LLMService.buildPrompt() 的 memorySection
    ↓
LLM 根据用户偏好生成个性化播客
```

## 六、待实现的自动触发机制

```swift
// 在 BehaviorTracker.endPlaybackSession() 末尾添加：
func endPlaybackSession(finalPosition: Double) {
    // ... 现有逻辑 ...

    // 检查是否需要更新记忆
    let totalSessions = getRecentPlaybackSessions(limit: 1000).count
    if totalSessions % 10 == 0 {
        Task {
            try? await memoryManager?.updateMemoryFromBehavior()
        }
    }
}
```



```
原始行为数据 → 定期分析 → 更新MD记忆 → 生成播客时读取
(BehaviorTracker)  (LLM分析)   (文件更新)    (Prompt注入)
```

### 与现有系统的整合

```swift
// PodcastService 生成播客时
func generatePodcast(topic: String) {
    // 1. 读取记忆摘要
    let memorySummary = memoryManager.loadSummary()
    let preferences = memoryManager.loadPreferences()

    // 2. 构建个性化 prompt
    let systemPrompt = """
    你是一个 AI 播客生成助手。以下是用户的记忆信息：

    \(memorySummary)

    详细偏好：
    \(preferences)

    请基于以上信息，生成一期关于「\(topic)」的个性化播客。
    """

    // 3. 调用 Claude API
}
```

---

## 七、更新原则（非常关键）

### ❌ 不要做的事
- 每轮对话都改
- 自动无限追加
- 因为一句"今天有点烦"就改文件

### ✅ 建议机制

**1. 更新触发时机**：
- 完成第 5/10/20 次播放后
- 用户在聊天中明确表达偏好（"我不喜欢..."）
- 话题偏好分数发生显著变化（±20分）

**2. 更新流程**：
```
每次对话/播放结束后
  ↓
让 LLM 判断：是否出现值得更新长期记忆的信息？
  ↓
如果有 → 输出修改建议 → 更新对应 MD 文件
  ↓
重新生成 memory_summary.md
```

**3. 只在出现"长期稳定信息"时更新**：
- "我其实一直不喜欢娱乐播客" ✅
- "我最近决定专攻 AI 方向" ✅
- "今天有点烦" ❌

---

## 八、文件大小控制

**目标**：
- 每个 md 控制在 300-800 字以内
- 总记忆不超过 2000 字

**一旦变大**：
让 LLM 重新总结压缩，保留关键信息

---

## 九、文件对比总结

| 文件 | 更新频率 | 信息类型 | 主要作用 | 字数限制 |
|------|---------|---------|---------|---------|
| profile.md | 极低 | 长期稳定 | 理解用户是谁 | 300-500字 |
| preferences.md | 高 | 动态偏好 | **生成个性化内容的直接依据** | 500-800字 |
| goals.md | 中等 | 阶段性目标 | 让内容对当前阶段有用 | 300-500字 |
| memory_summary.md | 自动 | 压缩摘要 | 节省 token，快速决策 | 200-300字 |

---

## 十、实现优先级

### Phase 1（已完成 ✅）
1. ✅ 创建 MemoryManager 服务
2. ✅ 实现 MD 文件的读写功能
3. ✅ 在生成播客时注入 memory_summary.md
4. ✅ 实现 LLM 版本的 generateSummary（智能压缩 + 自动降级）

### Phase 2（已完成 ✅）
1. ✅ 实现从 BehaviorTracker 数据生成 preferences.md（手动触发）
2. ✅ 添加播放次数阈值触发机制（每 10 次播放自动更新）
3. ✅ 实现 memory_summary.md 的 LLM 自动生成
4. ✅ 实现记忆文件编辑功能（用户可在 UI 上编辑）

### Phase 3（已完成 ✅）
1. ✅ 完善 profile.md 和 goals.md 的更新逻辑（从聊天中提取）
2. ✅ 添加记忆压缩功能（文件超过 800 字时自动压缩）
3. ✅ 优化更新频率和触发条件

---## 九、核心理念（播客产品专属）

记忆最关键的不是"他说过什么"，而是：

🎯 **他喜欢听什么**
🎯 **他想成为什么样的人**

记忆系统应该围绕：
- 兴趣
- 目标
- 内容风格

而不是聊天细节。
